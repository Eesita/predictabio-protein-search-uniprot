<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öñÔ∏è Evaluation View - Protein Search</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .sessions-panel {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: calc(100vh - 200px);
        }

        .sessions-list {
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            overflow-y: auto;
            padding: 20px;
        }

        .sessions-list h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .session-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .session-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }

        .session-item h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .session-item .meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .session-item .score {
            font-size: 14px;
            font-weight: bold;
            color: #27ae60;
        }

        .trace-view {
            padding: 30px;
            overflow-y: auto;
            background: white;
        }

        .trace-view h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .trace-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .trace-node {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .trace-node:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .node-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .node-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .node-status.success {
            background: #d4edda;
            color: #155724;
        }

        .node-status.clarification {
            background: #fff3cd;
            color: #856404;
        }

        .node-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .node-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .node-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .node-section h4 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .node-section pre {
            background: #f1f2f6;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }

        .node-section code {
            font-family: 'Courier New', monospace;
        }

        .evaluation-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .evaluation-badge h4 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .evaluation-badge .score {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .evaluation-badge .rationale {
            font-size: 14px;
            opacity: 0.95;
            font-style: italic;
        }

        /* Scrollbar styling */
        .sessions-list::-webkit-scrollbar,
        .trace-view::-webkit-scrollbar {
            width: 8px;
        }

        .sessions-list::-webkit-scrollbar-track,
        .trace-view::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .sessions-list::-webkit-scrollbar-thumb,
        .trace-view::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .sessions-list::-webkit-scrollbar-thumb:hover,
        .trace-view::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öñÔ∏è Evaluation View</h1>
            <p>Complete workflow traces and LLM-as-Judge evaluations</p>
        </div>

        <div class="sessions-panel">
            <div class="sessions-list">
                <h2>Sessions</h2>
                <div id="sessionsContainer">
                    <div class="empty-state">
                        <h3>No sessions yet</h3>
                        <p>Conversations will appear here after evaluation</p>
                    </div>
                </div>
            </div>

            <div class="trace-view">
                <div id="traceContainer">
                    <div class="empty-state">
                        <h3>Select a session</h3>
                        <p>Choose a session from the left to view its trace</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let sessions = [];
        let currentSession = null;

        // Fetch sessions from backend
        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/sessions`);
                if (response.ok) {
                    sessions = await response.json();
                    renderSessions();
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
                document.getElementById('sessionsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading sessions</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sessions yet</h3>
                        <p>Conversations will appear here after evaluation</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map((session, index) => `
                <div class="session-item ${index === 0 ? 'active' : ''}" onclick="selectSession(${index})">
                    <h3>Session ${session.id || index + 1}</h3>
                    <div class="meta">${session.timestamp || 'Unknown time'}</div>
                    <div class="meta">${session.message_count || 0} messages</div>
                    ${session.score ? `<div class="score">Score: ${session.score}/10</div>` : ''}
                </div>
            `).join('');
        }

        async function selectSession(index) {
            currentSession = sessions[index];
            
            // Update active state
            document.querySelectorAll('.session-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });

            // Load trace for this session
            await loadSessionTrace(currentSession.id || index);
        }

        async function loadSessionTrace(sessionId) {
            const container = document.getElementById('traceContainer');
            container.innerHTML = '<div class="empty-state"><h3>Loading trace...</h3></div>';

            try {
                const response = await fetch(`${API_BASE}/sessions/${sessionId}/trace`);
                if (response.ok) {
                    const traceData = await response.json();
                    renderTrace(traceData);
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>Trace not found</h3>
                            <p>No trace data available for this session</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading trace</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderTrace(traceData) {
            const container = document.getElementById('traceContainer');
            
            let html = `<h2>Session Trace: ${traceData.session_id || 'Unknown'}</h2>`;
            html += '<div class="trace-flow">';

            traceData.nodes.forEach((node, index) => {
                html += `
                    <div class="trace-node">
                        <div class="node-header">
                            <div class="node-title">${node.name || `Node ${index + 1}`}</div>
                            <div class="node-status ${getStatusClass(node.status)}">${getStatusLabel(node.status)}</div>
                        </div>
                        <div class="node-content">
                            <div class="node-section">
                                <h4>Input</h4>
                                <pre><code>${JSON.stringify(node.input, null, 2)}</code></pre>
                            </div>
                            <div class="node-section">
                                <h4>Output</h4>
                                <pre><code>${JSON.stringify(node.output, null, 2)}</code></pre>
                            </div>
                        </div>
                        ${node.evaluation ? `
                            <div class="evaluation-badge">
                                <h4>üéØ Node Evaluation</h4>
                                <div class="score">${node.evaluation.score}/10</div>
                                <div class="rationale">${node.evaluation.rationale}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += '</div>';

            // Add overall evaluation
            if (traceData.overall_evaluation) {
                html += `
                    <div style="margin-top: 20px;">
                        <div class="evaluation-badge">
                            <h4>‚öñÔ∏è Overall Session Evaluation</h4>
                            <div class="score">${traceData.overall_evaluation.score}/10</div>
                            <div class="rationale">${traceData.overall_evaluation.rationale}</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function getStatusClass(status) {
            const statusMap = {
                'success': 'success',
                'await_user': 'clarification',
                'fallback': 'error'
            };
            return statusMap[status] || '';
        }

        function getStatusLabel(status) {
            const labelMap = {
                'success': '‚úì Success',
                'await_user': '‚ö† Clarification',
                'fallback': '‚úó Error'
            };
            return labelMap[status] || status;
        }

        // Auto-select first session on load
        function autoSelectFirst() {
            if (sessions.length > 0) {
                selectSession(0);
            }
        }

        // Load sessions on page load
        window.addEventListener('load', async () => {
            await loadSessions();
            if (sessions.length > 0) {
                await autoSelectFirst();
            }
        });

        // Poll for new sessions every 30 seconds
        setInterval(() => {
            loadSessions();
        }, 30000);
    </script>
</body>
</html>
